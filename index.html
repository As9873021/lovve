<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>æˆ‘å€‘çš„ LINE æƒ…ä¾¶ç…§ç‰‡ç‰†</title>

  <!-- LIFF v2 SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: linear-gradient(135deg, #ffe5ec, #fff0f5);
      min-height: 100vh;
      padding: 16px;
      display: flex;
      justify-content: center;
    }
    .app {
      width: 100%;
      max-width: 900px;
      background: rgba(255,255,255,0.95);
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.08);
    }
    .header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 8px;
    }
    .avatar {
      width: 42px;
      height: 42px;
      border-radius: 999px;
      background: #ffd1e3;
      overflow: hidden;
      flex-shrink: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #fff;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .header-text h1 {
      font-size: 20px;
      margin-bottom: 2px;
    }
    .header-text p {
      font-size: 12px;
      color: #666;
    }
    .status {
      font-size: 11px;
      color: #888;
      margin-bottom: 4px;
    }
    .year-label {
      font-size: 13px;
      color: #555;
      margin-bottom: 8px;
    }
    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 12px;
    }
    .card {
      background: #fff;
      border-radius: 14px;
      padding: 8px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.06);
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    .card img {
      width: 100%;
      border-radius: 10px;
      object-fit: cover;
      max-height: 180px;
    }
    .card-text {
      font-size: 12px;
      color: #444;
      white-space: pre-wrap;
    }
    .card-meta {
      font-size: 10px;
      color: #999;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .tag {
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 10px;
      background: #ffe5ec;
      color: #c2527b;
    }
    .empty {
      font-size: 13px;
      color: #777;
      text-align: center;
      margin-top: 12px;
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="header">
      <div class="avatar" id="avatar">ğŸ’•</div>
      <div class="header-text">
        <h1>æˆ‘å€‘çš„ç…§ç‰‡ç‰†</h1>
        <p id="subtitle">æ­£åœ¨å¾ LINE å–å¾—ä½ çš„è³‡æ–™...</p>
      </div>
    </div>

    <div class="status" id="status"></div>
    <div class="year-label" id="year-label"></div>

    <div class="grid" id="photo-grid"></div>
    <div class="empty" id="empty-msg" style="display:none;">é€™ä¸€å¹´é‚„æ²’æœ‰ä»»ä½•ç…§ç‰‡ã€‚</div>
  </div>

  <script>
    const LIFF_ID  = '2008662868-yAm8omQe';
    const API_BASE = 'https://pipier-southward-niesha.ngrok-free.dev';

    const avatarDiv  = document.getElementById('avatar');
    const subtitleEl = document.getElementById('subtitle');
    const statusEl   = document.getElementById('status');
    const yearLabel  = document.getElementById('year-label');
    const photoGrid  = document.getElementById('photo-grid');
    const emptyMsg   = document.getElementById('empty-msg');

    function getYearFromUrl() {
      const params = new URLSearchParams(window.location.search);
      const y = params.get('year');
      const now = new Date().getFullYear().toString();
      return /^\d{4}$/.test(y) ? y : now;
    }

    async function initLiffAndLoad() {
      try {
        statusEl.textContent = 'åˆå§‹åŒ– LIFF ä¸­...';

        await liff.init({ liffId: LIFF_ID });

        if (!liff.isLoggedIn()) {
          statusEl.textContent = 'å°šæœªç™»å…¥ LINEï¼Œå°å‘ç™»å…¥é é¢...';
          liff.login();
          return;
        }

        const profile = await liff.getProfile();
        subtitleEl.textContent = `å—¨ï¼Œ${profile.displayName}ï¼Œä¸€èµ·çœ‹ä½ å€‘çš„å›æ†¶å§ ğŸ’•`;
        statusEl.textContent = 'å·²å¾ LINE å–å¾—ä½ çš„èº«ä»½è³‡è¨Šã€‚';

        if (profile.pictureUrl) {
          avatarDiv.innerHTML = '';
          const img = document.createElement('img');
          img.src = profile.pictureUrl;
          avatarDiv.appendChild(img);
        }

        const year = getYearFromUrl();
        yearLabel.textContent = `ç›®å‰é¡¯ç¤ºï¼š${year} å¹´çš„ç›¸ç°¿`;
        await loadPhotos(year);
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'LIFF åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹ç¢ºèªè¨­å®šæ˜¯å¦æ­£ç¢ºã€‚';
      }
    }

    async function loadPhotos(year) {
      statusEl.textContent = 'è®€å–ç›¸ç°¿ä¸­...';
      photoGrid.innerHTML = '';
      emptyMsg.style.display = 'none';

      try {
        const res = await fetch(`${API_BASE}/photos?year=${encodeURIComponent(year)}`);
        if (!res.ok) throw new Error('API error');
        const data = await res.json();
        const photos = data.photos || [];

        if (photos.length === 0) {
          emptyMsg.style.display = 'block';
          statusEl.textContent = 'é€™ä¸€å¹´ç›®å‰æ²’æœ‰ç…§ç‰‡ã€‚';
          return;
        }

        photos
          .sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt))
          .forEach((p) => {
            const card = document.createElement('div');
            card.className = 'card';

            const img = document.createElement('img');
            img.src = p.url;

            const textDiv = document.createElement('div');
            textDiv.className = 'card-text';
            textDiv.textContent = p.text || 'ï¼ˆé‚„æ²’æœ‰å‚™è¨»ã€‚ï¼‰';

            const meta = document.createElement('div');
            meta.className = 'card-meta';

            const d = new Date(p.createdAt);
            const dateSpan = document.createElement('span');
            dateSpan.textContent = d.toLocaleString();

            const tag = document.createElement('span');
            tag.className = 'tag';
            tag.textContent = `${year} çš„å›æ†¶`;

            meta.appendChild(dateSpan);
            meta.appendChild(tag);

            card.appendChild(img);
            card.appendChild(textDiv);
            card.appendChild(meta);

            photoGrid.appendChild(card);
          });

        statusEl.textContent = `å…± ${photos.length} å¼µç…§ç‰‡ã€‚`;
      } catch (err) {
        console.error(err);
        statusEl.textContent = 'è®€å–ç›¸ç°¿å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
        emptyMsg.style.display = 'block';
        emptyMsg.textContent = 'è®€å–ç›¸ç°¿å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚';
      }
    }

    document.addEventListener('DOMContentLoaded', initLiffAndLoad);
  </script>
</body>
</html>
